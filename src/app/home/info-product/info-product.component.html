<div class="container">
  <div class="row mb-5 mt-3">
    <div class="chitietSanpham col-lg-12">
      <h3>{{ product.productName }}</h3>
      <div class="rowdetail group">
        <div class="picture">
          <div class="main-image">
            <img class="main-image" [src]="selectedImage || getImage(product.avt)"/>
          </div>
          <div class="thumbnail-list">
            <img *ngFor="let img of getImages(product.avt)" [src]="img" (click)="selectImage(img)"
              [class.active]="img === selectedImage" alt="Ảnh nhỏ">
            </div>
          </div>
        <div class="price_sale">
          <div class="area_price">
            <div *ngIf="hasDiscount(product)" class="price-box">
              <span class="price-origin">
                {{ numToString(product.price) }} ₫
              </span>
              <span class="price-sale">
                {{ numToString(finalPrice) }} ₫
              </span>
            </div>

            <div *ngIf="!hasDiscount(product)" class="price-box">
              <span class="price-normal">
                {{ numToString(product.price) }} ₫
              </span>
            </div>
          </div>

          @if (hasPromotion(product)) {
            <div class="area_promo">
              <strong>Khuyến mãi</strong>
              <div class="promo">
                <i class="fa fa-check-circle"></i>
                <div id="detailPromo">
                  Giảm
                  @if (product.promotion.typePromotion === 'PERCENT') {
                    <b>{{ product.promotion.promotionalValue }}%</b>
                  } @else {
                    <b>{{ numToString(product.promotion.promotionalValue) }}đ</b>
                  }
                  khi mua sản phẩm
                </div>
              </div>
            </div>
          }

          <div class="policy">
            <div class="last">
              <i class="fa fa-suitcase"></i>
              <p>Tặng balo khi mua laptop</p>
            </div>
            <div class="last">
              <i class="fa fa-gift"></i>
              <p>Tặng ốp điện thoại khi mua smartphone</p>
            </div>
            <div>
              <i class="fa fa-star"></i>
              <p>Bảo hành chính hãng 12 tháng.</p>
            </div>
            <div class="last">
              <i class="fa fa-retweet"></i>
              <p>1 đổi 1 trong 1 tháng nếu lỗi.</p>
            </div>
          </div>

          <div class="area_order">
            <a class="buy_now" *ngIf="product.quantity > 0" (click)="add()">
              <h3>
                <i class="fa fa-cart-plus"></i> Thêm vào giỏ hàng
              </h3>
            </a>
            <div class="out_of_stock" *ngIf="product.quantity === 0">
              <h3>Hàng sắp về</h3>
              <p>Vui lòng liên hệ <strong>18002026</strong></p>
            </div>
          </div>

        </div>

        <div class="info_product">
          <h2>Thông số kỹ thuật</h2>
          <ul class="info">
            @for (item of specs; track item.label) {
              <li>
                <p>{{ item.label }}</p>
                <div>{{ item.value }}</div>
              </li>
            }
          </ul>
        </div>
      </div>
    </div>
  </div>
  <hr />

  <div class="comment-area">
    <div class="review-top">
      <div class="review-summary">
        <h3>Đánh giá sản phẩm</h3>
        <div class="summary-score">
          <span class="score">{{ product.numOfStar }}/5</span>
          <ngb-rating [max]="5" [(rate)]="product.numOfStar" [readonly]="true"></ngb-rating>
          <p>{{ product.numOfReview }} lượt đánh giá</p>
        </div>

        <div class="rating-breakdown">
          @for (s of [5,4,3,2,1]; track s) {
            <div class="rating-row">
              <span class="star-label">{{ s }} ★</span>
              <div class="bar">
                <div class="fill" [style.width.%]="getStarPercent(s)"></div>
              </div>
              <span class="count">
                {{ getStarCount(s) }} đánh giá
              </span>
            </div>
          }
        </div>
      </div>

      <div class="review-form">
        <form [formGroup]="createE">
          <div class="stars">
            @for (s of [5,4,3,2,1]; track s) {
              <input class="star star-{{s}}" id="star-{{s}}" type="radio" [value]="s" name="numOfStar" formControlName="numOfStar" />
              <label class="star star-{{s}}" for="star-{{s}}"></label>
            }
          </div>

          <textarea maxlength="250" placeholder="Viết suy nghĩ của bạn vào đây..." formControlName="comment"></textarea>
          <button type="button" (click)="createRating()"> GỬI BÌNH LUẬN</button>
        </form>
      </div>
    </div>

    <div class="review-filter">
      <span>Lọc đánh giá theo:</span>
      @for (f of filters; track f.value) {
        <button
          [class.active]="selectedStar === f.value"
          (click)="filterByStar(f.value)">
          {{ f.label }}
        </button>
      }
    </div>

    <div class="container-comment">
      @for (i of filteredComments; track i.id) {
        <div class="comment">
          <i class="fa fa-user-circle"></i>
          <div class="comment-body">
            <h4>
              {{ i.customer.surname + ' ' + i.customer.name }}
              <ngb-rating [max]="5" [(rate)]="i.numberOfStar" [readonly]="true" style="margin-left: 48px;"></ngb-rating>
            </h4>
            <p>{{ i.comment }}</p>
            <span class="fa fa-clock-o"> Đánh giá đã đăng vào {{ getTimeAgo(i.dateFounded) }}</span>
          </div>
        </div>
      }

      @if (filteredComments.length === 0) {
        <p class="empty">Chưa có đánh giá phù hợp</p>
      }

    </div>
  </div>

  <div class="related-section">
    <h3>Có thể bạn sẽ thích ({{ product.nameType || '—' }})</h3>
    <div class="related-grid">
      @for (p of relatedProducts; track p.idProduct) {
        <div class="related-item">
          <label *ngIf="hasDiscount(p)" class="promotion-badge">
            Giảm giá
          </label>

          <a class="thumb" (click)="loadProduct(p.idProduct)">
            <img [src]="getImage(p.avt)" />
          </a>

          <a class="name" (click)="loadProduct(p.idProduct)">
            {{ p.productName }}
          </a>

          <div class="price">
            <ng-container *ngIf="hasDiscount(p); else noDiscount">
              <div class="price-goc">
                {{ numToString(p.price) }}đ
              </div>
              <div class="price-giam">
                {{ numToString(getDiscountedPrice(p)) }}đ
              </div>
            </ng-container>

            <ng-template #noDiscount>
              <div class="price-thuong">
                {{ numToString(p.price) }}đ
              </div>
            </ng-template>
          </div>
        </div>
      }
    </div>
  </div>
</div>
